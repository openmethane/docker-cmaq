!        Generated by TAPENADE     (INRIA, Tropics team)
!  Tapenade 3.4 (r3376) - 10 Feb 2010 17:51
! revised by shunliu zhao
!:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
      MODULE AERO_DATA_B
	use AERO_DATA
        IMPLICIT NONE
        REAL :: aerospc_concb(n_aerospc, n_mode)
        REAL :: moment0_concb(n_mode)
        REAL :: moment2_concb(n_mode)
        REAL :: moment3_concb(n_mode)
	  REAL :: aeromode_massb(n_mode)
        REAL :: aeromode_densb(n_mode)
	  REAL :: aeromode_diamb(n_mode)
        REAL :: aeromode_sdevb(n_mode)
        CHARACTER(len=16), PRIVATE, SAVE :: pname='Aero_Data_b'

      CONTAINS
!  Differentiation of extract_aero in reverse (adjoint) mode:
!   gradient     of useful results: moment0_conc moment2_conc aerospc_conc
!                conc
!   with respect to varying inputs: conc
!
!-----------------------------------------------------------------------
        SUBROUTINE EXTRACT_AERO_B(conc, concb)
          IMPLICIT NONE
!
! Arguments:
          REAL, INTENT(IN) :: conc(:)
          REAL :: concb(:)
!
! Local Variables:
          CHARACTER(len=80) :: xmsg
          INTEGER :: m, n, spc
	    
          DO m=1,n_mode
            n = aerosrf_map(m)
            IF (conc(n) .GE. aeromode(m)%min_m2conc) THEN
              concb(n) = concb(n) + moment2_concb(m) 
            END IF
		moment2_concb(m) = 0.0
            n = aeronum_map(m)
            IF (conc(n) .GE. aeromode(m)%min_numconc) THEN
              concb(n) = concb(n) + moment0_concb(m)
            END IF
		moment0_concb(m) = 0.0
          END DO
	    
          DO m=1,n_mode
            DO spc=1,n_aerospc
		  n = aerospc_map(spc, m)
              IF (n.ne.0) THEN
                IF (conc(n) .GE. aerospc(spc)%min_conc(m)) THEN
                  concb(n) = concb(n) + aerospc_concb(spc, m) 
                END IF
		    aerospc_concb(spc, m) = 0.0
		  end if
            END DO
          END DO
        END SUBROUTINE EXTRACT_AERO_B
!-----------------------------------------------------------------------
        SUBROUTINE UPDATE_AERO_B(conc, concb)
          USE MET_DATA
          IMPLICIT NONE
          INCLUDE SUBST_IOPARMS
!
!  Updates aerosol values in CGRID from the conc array.
!  Revision History:
!     First version was coded in April 2010 by Steve Howard with
!     Prakash Bhave, Jeff Young, and Sergey Napelenok.
!-----------------------------------------------------------------------
!
!fundamental constants, data type definitions, etc.
!
! arguments:
          REAL :: conc(:)
          REAL :: concb(:)
!
! local variables:
          CHARACTER(len=80) :: xmsg
          INTEGER :: m, n, spc
	    
          DO m=1,n_mode
            n = aerosrf_map(m)
            moment2_concb(m) = moment2_concb(m) + pi*concb(n)
            concb(n) = 0.0
		
            n = aeronum_map(m)
            IF (moment0_conc(m) .GE. aeromode(m)%min_numconc) THEN
              moment0_concb(m) = moment0_concb(m) + concb(n)
            END IF
		concb(n) = 0.0
          END DO
	    
          DO m=1,n_mode
            DO spc=1,n_aerospc
		  n = aerospc_map(spc, m)
              IF (n.ne.0) THEN
                IF (aerospc_conc(spc, m) .GE. aerospc(spc)%min_conc(m)) THEN
                  aerospc_concb(spc, m) = aerospc_concb(spc, m) + concb(n) 
		    end if
		    concb(n) = 0.0
              END IF
            END DO
          END DO
        END SUBROUTINE UPDATE_AERO_B
      END MODULE AERO_DATA_B
